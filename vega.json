{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "Test Execution Status for Last Run ID per Subdomain",
  "data": [
    {
      "name": "table",
      "url": {
        "%context%": true,
        "%timefield%": "runID",
        "index": "test-executions-*",
        "body": {
          "size": 0,
          "aggs": {
            "by_subdomain": {
              "terms": {
                "field": "subdomain.keyword",
                "size": 1000
              },
              "aggs": {
                "latest_run": {
                  "top_hits": {
                    "sort": [
                      {
                        "runID": {
                          "order": "desc"
                        }
                      }
                    ],
                    "_source": {
                      "includes": ["runID", "TestcaseName", "ExecutionStatus", "domain"]
                    },
                    "size": 1
                  }
                },
                "status_counts": {
                  "terms": {
                    "field": "ExecutionStatus.keyword"
                  }
                }
              }
            }
          }
        }
      },
      "format": {
        "property": "aggregations.by_subdomain.buckets"
      },
      "transform": [
        {
          "type": "formula",
          "as": "subdomain",
          "expr": "datum.key"
        },
        {
          "type": "formula",
          "as": "domain",
          "expr": "datum.latest_run.hits.hits[0]._source.domain"
        },
        {
          "type": "formula",
          "as": "runID",
          "expr": "datum.latest_run.hits.hits[0]._source.runID"
        },
        {
          "type": "aggregate",
          "groupby": ["subdomain"],
          "fields": ["datum.status_counts.buckets['Passed'].doc_count", "datum.status_counts.buckets['Failed'].doc_count"],
          "ops": ["sum", "sum"],
          "as": ["Passed", "Failed"]
        },
        {
          "type": "formula",
          "as": "TotalTestCase",
          "expr": "datum.Passed + datum.Failed"
        }
      ]
    }
  ],
  "scales": [
    {
      "name": "xscale",
      "type": "band",
      "domain": {"data": "table", "field": "subdomain"},
      "range": "width",
      "padding": 0.05
    },
    {
      "name": "yscale",
      "type": "linear",
      "domain": {"data": "table", "field": "TotalTestCase"},
      "range": "height",
      "nice": true
    }
  ],
  "axes": [
    {"orient": "bottom", "scale": "xscale"},
    {"orient": "left", "scale": "yscale"}
  ],
  "marks": [
    {
      "type": "group",
      "from": {
        "facet": {
          "data": "table",
          "name": "facet",
          "groupby": "subdomain"
        }
      },
      "marks": [
        {
          "type": "rect",
          "from": {"data": "facet"},
          "encode": {
            "enter": {
              "x": {"scale": "xscale", "field": "subdomain"},
              "width": {"scale": "xscale", "band": 1},
              "y": {"scale": "yscale", "field": "TotalTestCase"},
              "y2": {"scale": "yscale", "value": 0},
              "fill": {"value": "steelblue"}
            }
          }
        },
        {
          "type": "text",
          "from": {"data": "facet"},
          "encode": {
            "enter": {
              "x": {"scale": "xscale", "field": "subdomain", "band": 0.5},
              "y": {"scale": "yscale", "field": "TotalTestCase", "offset": -5},
              "text": {"field": "TotalTestCase"},
              "align": {"value": "center"},
              "baseline": {"value": "middle"},
              "fill": {"value": "black"}
            }
          }
        }
      ]
    }
  ]
}
